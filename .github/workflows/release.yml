name: å‘å¸ƒè·¨å¹³å°æ„å»º

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'ç‰ˆæœ¬å· (ä¾‹å¦‚: v1.0.0)'
        required: true
        default: 'v0.1.0'

env:
  CARGO_INCREMENTAL: 0
  RUST_BACKTRACE: short

jobs:
  # è·å–ç‰ˆæœ¬ä¿¡æ¯
  get-version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      prerelease: ${{ steps.version.outputs.prerelease }}
    steps:
      - name: è·å–ç‰ˆæœ¬å·
        id: version
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${GITHUB_REF#refs/tags/}"
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          if [[ "$VERSION" == *"-"* ]]; then
            echo "prerelease=true" >> $GITHUB_OUTPUT
          else
            echo "prerelease=false" >> $GITHUB_OUTPUT
          fi

  # æ„å»ºè·¨å¹³å°ç‰ˆæœ¬
  build:
    needs: get-version
    strategy:
      matrix:
        include:
          # Windows x64
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            platform: windows-x64
            arch: x64
            ext: .exe
            
          # Windows ARM64
          - os: windows-latest
            target: aarch64-pc-windows-msvc
            platform: windows-arm64
            arch: arm64
            ext: .exe
            
          # macOS Intel
          - os: macos-latest
            target: x86_64-apple-darwin
            platform: macos-x64
            arch: x64
            ext: ''
            
          # macOS Apple Silicon
          - os: macos-latest
            target: aarch64-apple-darwin
            platform: macos-arm64
            arch: arm64
            ext: ''
            
          # Linux x64
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            platform: linux-x64
            arch: x64
            ext: ''
            
          # Linux ARM64
          - os: ubuntu-latest
            target: aarch64-unknown-linux-gnu
            platform: linux-arm64
            arch: arm64
            ext: ''

    runs-on: ${{ matrix.os }}
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        
      - name: å®‰è£… Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: å®‰è£…å‰ç«¯ä¾èµ–
        run: npm ci
        
      - name: å®‰è£… Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable
          target: ${{ matrix.target }}
          cache: true
          
      # Windows ç‰¹å®šè®¾ç½®
      - name: å®‰è£… Windows æ„å»ºå·¥å…· (Windows)
        if: matrix.os == 'windows-latest'
        run: |
          choco install visualstudio2022buildtools --package-parameters "--add Microsoft.VisualStudio.Workload.VCTools --includeRecommended"
          
      # Linux ç‰¹å®šè®¾ç½®
      - name: å®‰è£… Linux ä¾èµ– (Linux)
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt update
          sudo apt install -y \
            libwebkit2gtk-4.1-dev \
            libappindicator3-dev \
            librsvg2-dev \
            patchelf \
            libssl-dev \
            pkg-config \
            libglib2.0-dev \
            libgirepository1.0-dev
            
      # ARM64 äº¤å‰ç¼–è¯‘è®¾ç½® (Linux)
      - name: å®‰è£… ARM64 äº¤å‰ç¼–è¯‘å·¥å…· (Linux ARM64)
        if: matrix.os == 'ubuntu-latest' && matrix.target == 'aarch64-unknown-linux-gnu'
        run: |
          sudo apt install -y gcc-aarch64-linux-gnu
          echo "CC_aarch64_unknown_linux_gnu=aarch64-linux-gnu-gcc" >> $GITHUB_ENV
          echo "CXX_aarch64_unknown_linux_gnu=aarch64-linux-gnu-g++" >> $GITHUB_ENV
          
      # macOS ç‰¹å®šè®¾ç½®
      - name: å®‰è£… macOS ä¾èµ– (macOS)
        if: matrix.os == 'macos-latest'
        run: |
          # ç¡®ä¿ Xcode å‘½ä»¤è¡Œå·¥å…·å·²å®‰è£…
          xcode-select --install || true
          
      - name: æ„å»ºå‰ç«¯
        run: npm run build
        
      - name: æ„å»º Tauri åº”ç”¨
        run: npm run tauri build -- --target ${{ matrix.target }}
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
          
      # æ”¶é›†æ„å»ºäº§ç‰©
      - name: æ”¶é›†æ„å»ºäº§ç‰© (Windows)
        if: matrix.os == 'windows-latest'
        run: |
          mkdir -p dist
          $bundlePath = "src-tauri/target/${{ matrix.target }}/release/bundle"
          
          # MSI å®‰è£…åŒ…
          if (Test-Path "$bundlePath/msi") {
            Get-ChildItem "$bundlePath/msi/*.msi" | ForEach-Object {
              $newName = "excaliapp-${{ needs.get-version.outputs.version }}-${{ matrix.platform }}.msi"
              Copy-Item $_.FullName "dist/$newName"
            }
          }
          
          # NSIS å®‰è£…åŒ…
          if (Test-Path "$bundlePath/nsis") {
            Get-ChildItem "$bundlePath/nsis/*-setup.exe" | ForEach-Object {
              $newName = "excaliapp-${{ needs.get-version.outputs.version }}-${{ matrix.platform }}-setup.exe"
              Copy-Item $_.FullName "dist/$newName"
            }
          }
          
          # å¯æ‰§è¡Œæ–‡ä»¶
          $exePath = "src-tauri/target/${{ matrix.target }}/release/excaliapp.exe"
          if (Test-Path $exePath) {
            Copy-Item $exePath "dist/excaliapp-${{ needs.get-version.outputs.version }}-${{ matrix.platform }}.exe"
          }
        shell: powershell
        
      - name: æ”¶é›†æ„å»ºäº§ç‰© (macOS)
        if: matrix.os == 'macos-latest'
        run: |
          mkdir -p dist
          bundle_path="src-tauri/target/${{ matrix.target }}/release/bundle"
          
          # DMG å®‰è£…åŒ…
          if [ -d "$bundle_path/dmg" ]; then
            find "$bundle_path/dmg" -name "*.dmg" -exec cp {} "dist/excaliapp-${{ needs.get-version.outputs.version }}-${{ matrix.platform }}.dmg" \;
          fi
          
          # App åŒ…
          if [ -d "$bundle_path/macos" ]; then
            find "$bundle_path/macos" -name "*.app" -exec tar -czf "dist/excaliapp-${{ needs.get-version.outputs.version }}-${{ matrix.platform }}.app.tar.gz" {} \;
          fi
          
          # å¯æ‰§è¡Œæ–‡ä»¶
          exe_path="src-tauri/target/${{ matrix.target }}/release/excaliapp"
          if [ -f "$exe_path" ]; then
            cp "$exe_path" "dist/excaliapp-${{ needs.get-version.outputs.version }}-${{ matrix.platform }}"
          fi
        
      - name: æ”¶é›†æ„å»ºäº§ç‰© (Linux)
        if: matrix.os == 'ubuntu-latest'
        run: |
          mkdir -p dist
          bundle_path="src-tauri/target/${{ matrix.target }}/release/bundle"
          
          # AppImage
          if [ -d "$bundle_path/appimage" ]; then
            find "$bundle_path/appimage" -name "*.AppImage" -exec cp {} "dist/excaliapp-${{ needs.get-version.outputs.version }}-${{ matrix.platform }}.AppImage" \;
          fi
          
          # DEB åŒ…
          if [ -d "$bundle_path/deb" ]; then
            find "$bundle_path/deb" -name "*.deb" -exec cp {} "dist/excaliapp-${{ needs.get-version.outputs.version }}-${{ matrix.platform }}.deb" \;
          fi
          
          # RPM åŒ…
          if [ -d "$bundle_path/rpm" ]; then
            find "$bundle_path/rpm" -name "*.rpm" -exec cp {} "dist/excaliapp-${{ needs.get-version.outputs.version }}-${{ matrix.platform }}.rpm" \;
          fi
          
          # å¯æ‰§è¡Œæ–‡ä»¶
          exe_path="src-tauri/target/${{ matrix.target }}/release/excaliapp"
          if [ -f "$exe_path" ]; then
            cp "$exe_path" "dist/excaliapp-${{ needs.get-version.outputs.version }}-${{ matrix.platform }}"
          fi
          
      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.platform }}
          path: dist/*
          retention-days: 7

  # åˆ›å»º GitHub Release
  release:
    needs: [get-version, build]
    runs-on: ubuntu-latest
    if: always() && needs.build.result == 'success'
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        
      - name: ä¸‹è½½æ‰€æœ‰æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          
      - name: æ•´ç†å‘å¸ƒæ–‡ä»¶
        run: |
          mkdir -p release
          find artifacts -type f -exec cp {} release/ \;
          ls -la release/
          
      - name: ç”Ÿæˆæ›´æ–°æ—¥å¿—
        id: changelog
        run: |
          VERSION="${{ needs.get-version.outputs.version }}"
          echo "## ğŸš€ excaliapp ${VERSION} å‘å¸ƒ" > CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "### ğŸ“¦ ä¸‹è½½" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "| å¹³å° | æ¶æ„ | ä¸‹è½½é“¾æ¥ |" >> CHANGELOG.md
          echo "|------|------|----------|" >> CHANGELOG.md
          
          for file in release/*; do
            if [ -f "$file" ]; then
              filename=$(basename "$file")
              if [[ "$filename" == *"windows-x64"* ]]; then
                echo "| Windows | x64 | [\`$filename\`]($file) |" >> CHANGELOG.md
              elif [[ "$filename" == *"windows-arm64"* ]]; then
                echo "| Windows | ARM64 | [\`$filename\`]($file) |" >> CHANGELOG.md
              elif [[ "$filename" == *"macos-x64"* ]]; then
                echo "| macOS | Intel | [\`$filename\`]($file) |" >> CHANGELOG.md
              elif [[ "$filename" == *"macos-arm64"* ]]; then
                echo "| macOS | Apple Silicon | [\`$filename\`]($file) |" >> CHANGELOG.md
              elif [[ "$filename" == *"linux-x64"* ]]; then
                echo "| Linux | x64 | [\`$filename\`]($file) |" >> CHANGELOG.md
              elif [[ "$filename" == *"linux-arm64"* ]]; then
                echo "| Linux | ARM64 | [\`$filename\`]($file) |" >> CHANGELOG.md
              fi
            fi
          done
          
          echo "" >> CHANGELOG.md
          echo "### âœ¨ ç‰¹æ€§" >> CHANGELOG.md
          echo "- ğŸ¨ å…¨æ–°ç®€æ´ç°ä»£çš„åº”ç”¨å›¾æ ‡è®¾è®¡" >> CHANGELOG.md
          echo "- ğŸ“± æ”¯æŒè·¨å¹³å°ï¼šWindowsã€macOSã€Linux" >> CHANGELOG.md
          echo "- ğŸ—ï¸ æ”¯æŒå¤šæ¶æ„ï¼šx64ã€ARM64" >> CHANGELOG.md
          echo "- ğŸ”§ åŸºäº Tauri 2.0 æ„å»ºï¼Œæ€§èƒ½ä¼˜å¼‚" >> CHANGELOG.md
          echo "- ğŸ¯ é›†æˆ Excalidrawï¼Œæœ¬åœ°åŒ–ç»˜å›¾ä½“éªŒ" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "### ğŸ’» å®‰è£…è¯´æ˜" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "**Windowsï¼š**" >> CHANGELOG.md
          echo "- ä¸‹è½½ \`.msi\` æ–‡ä»¶è¿›è¡Œå®‰è£…" >> CHANGELOG.md
          echo "- æˆ–ä¸‹è½½ \`-setup.exe\` å®‰è£…ç¨‹åº" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "**macOSï¼š**" >> CHANGELOG.md
          echo "- ä¸‹è½½ \`.dmg\` æ–‡ä»¶è¿›è¡Œå®‰è£…" >> CHANGELOG.md
          echo "- Intel Mac é€‰æ‹© \`macos-x64\`" >> CHANGELOG.md
          echo "- Apple Silicon Mac é€‰æ‹© \`macos-arm64\`" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "**Linuxï¼š**" >> CHANGELOG.md
          echo "- Ubuntu/Debian: ä¸‹è½½ \`.deb\` æ–‡ä»¶" >> CHANGELOG.md
          echo "- RHEL/CentOS: ä¸‹è½½ \`.rpm\` æ–‡ä»¶" >> CHANGELOG.md
          echo "- é€šç”¨: ä¸‹è½½ \`.AppImage\` æ–‡ä»¶" >> CHANGELOG.md
          
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          cat CHANGELOG.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
      - name: åˆ›å»º GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.get-version.outputs.version }}
          name: excaliapp ${{ needs.get-version.outputs.version }}
          body: ${{ steps.changelog.outputs.changelog }}
          files: release/*
          prerelease: ${{ needs.get-version.outputs.prerelease }}
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # æ„å»ºåæ¸…ç†
  cleanup:
    needs: [build, release]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: æ¸…ç†å·¥ä½œåŒº
        run: |
          echo "ğŸ§¹ æ„å»ºå®Œæˆï¼Œæ¸…ç†å·¥ä½œåŒº"
          echo "âœ… è·¨å¹³å°æ„å»ºå®Œæˆ"
          echo "ğŸ“¦ Release å·²åˆ›å»ºï¼š${{ needs.get-version.outputs.version }}"